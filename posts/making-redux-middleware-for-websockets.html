<!DOCTYPE html>
<html lang="en">
   <head>
       <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">
<title>Using Action Cable with Redux - Websocket Redux Middleware &#9642; NMajor Blog</title>
<!--
<meta name="description" content="This article uses ActionCable as the websocket library. If you want to see a version of this article using socket.io, click here. Middleware is one of the most powerful and useful features of redux. If you’re unfamiliar with redux middleware, it is a way to insert extra behavior into dispatched...">
-->
<meta name="description" content="A blog filled with adventures in tech">
<meta name="keywords" content="redux, javascript, websockets, react, rails, actioncable">
<link rel="canonical" href="/posts/making-redux-middleware-for-websockets">
<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="Using Action Cable with Redux - Websocket Redux Middleware" />
<meta name="twitter:description" content="A blog filled with adventures in tech" />
<meta name="twitter:image" content="" />
<meta name="author" content="">
<link rel="author" href="">
<meta property="og:locale" content="">
<meta property="og:type" content="article">
<meta property="og:title" content="Using Action Cable with Redux - Websocket Redux Middleware">
<meta property="og:description" content="A blog filled with adventures in tech">
<meta property="og:url" content="/posts/making-redux-middleware-for-websockets">
<meta property="og:site_name" content="NMajor Blog">
<link rel="stylesheet" href="/assets/vendor/normalize-css/normalize.css">
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700,700i">
<style>
    html {
      font-family: "Open Sans", "Helvetica Neue", sans-serif;
    }
</style>
<link rel="stylesheet" href="/assets/css/bf.css">
   <body>
       <div class="wrapper" id="blep">
          <header>
   <div class="menu">
     <div class="logo">
        <img src="/uploads/me4.jpg" />
        <a href="/">NMajor Blog</a>
     </div>
       <ul>
           <li><a href="/about">About</a>
           <li><a href="/projects">Projects</a>
           <li><a href="/archive">Archive</a>
       </ul>
   </div>
   <div class="social">
     <ul>
       <li>
            <a href="https://github.com/nmajor" target="_blank" class="smaller">
              <span class="icon-github"></span>
            </a>
       <li>
            <a href="https://twitter.com/_nmajor" target="_blank" class="smaller">
              <span class="icon-twitter"></span>
            </a>
       <li>
            <a href="https://linkedin.com/in/nmajor" target="_blank" class="smaller">
              <span class="icon2-linkedin"></span>
            </a>
       <li>
            <a href="http://blog.nmajor.com" target="_blank" class="smaller">
              <span class="icon2-globe"></span>
            </a>
       <li>
            <a href="https://instagram.com/_nmajor" target="_blank" class="smaller">
              <span class="icon2-instagram"></span>
            </a>
       <li>
            <a href="/feed.xml" target="_blank">
                <span class="icon-rss_feed"></span>
            </a>
     </ul>
   </div>
</header>
<article class="post">
 <div class="post-title-container
  no-hero-margin
  ">
    <!--Post hero image source-->
   <div class="heading-container ">
     <h1>
          Using Action Cable with Redux - Websocket Redux Middleware
     </h1>
      <span class="published-at">Published Jul 25, 2018</span>
      &#9642;
      <span class="post-tags">
            <a href="/tag/redux">#redux</a>
            <a href="/tag/javascript">#javascript</a>
            <a href="/tag/websockets">#websockets</a>
            <a href="/tag/react">#react</a>
            <a href="/tag/rails">#rails</a>
            <a href="/tag/actioncable">#actioncable</a>
      </span>
          <a href="/posts/making-redux-middleware-for-websockets" title="Using Action Cable with Redux - Websocket Redux Middleware"><img class="hero-image" src="/uploads/2018/07/25/Action Cable.png" /></a>
   </div>
 </div>
   <p>This article uses ActionCable as the websocket library. If you want to see a version of this article using socket.io, <a href="/posts/using-socket-io-with-redux-websocket-redux-middleware" title="/posts/using-socket-io-with-redux-websocket-redux-middleware">click here.</a>
<hr />
<p>Middleware is one of the most powerful and useful features of redux. If you’re unfamiliar with redux middleware, it is a way to insert extra behavior into dispatched redux actions.
<p>Today we’re going to use it to make a clean and powerful way to manage our subscriptions to different Action Cable channels+rooms. This also means taking the data sent to use through action cable and dispatching the appropriate redux actions to mutate the state.
<p class="lead">
<p>If you are unfamiliar with redux middleware, check out the <a href="https://redux.js.org/advanced/middleware" title="https://redux.js.org/advanced/middleware">documentation here</a>. The code below is inspired by reading through the source of <a href="https://github.com/erikras/react-redux-universal-hot-example" title="https://github.com/erikras/react-redux-universal-hot-example">this example redux app</a>, specifically <a href="https://github.com/erikras/react-redux-universal-hot-example/blob/master/src/redux/middleware/clientMiddleware.js" title="https://github.com/erikras/react-redux-universal-hot-example/blob/master/src/redux/middleware/clientMiddleware.js">this middleware</a>, so you may also want to check that out as well.
<h3 id="typical-redux-actions">Typical Redux Actions</h3>
<p>Basically redux action, by default, looks like this:
<div class="language-javascript highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre><td class="code"><pre><span class="p">{</span> <span class="nl">type</span><span class="p">:</span> <span class="s1">'MY_ACTION_TYPE'</span><span class="p">,</span> <span class="nx">other</span><span class="err">:</span> <span class="s1">'data'</span> <span class="p">}</span>
</pre></table>
</div>
</div>
<p>Redux actions have 1 required attribute, <code class="highlighter-rouge">type</code>. Anything else is just extra and is usually meant to be used by the reducer to mutate the state.
<p>By using redux middleware we can define our own action patterns and structures. The middleware will check if the action has other specific attributes and handle that action differently than the others. That way all we have to do to trigger some custom redux behavior is dispatch an action with our specific attributes and it will automatically be handled differently.
<p>Specifically we are going to create a new kind of action that will subscribe or unsubscribe to specific Action Cable channels+rooms.
<h3 id="middleware-function">Middleware Function</h3>
<p>First lets make a middleware function, you’ll want to export this function from a file. I called my file `cableMiddleware.js`:
<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37</pre><td class="code"><pre>import ActionCable from 'actioncable';

export default function cableMiddleware() {
  const cable = ActionCable.createConsumer('/cable');

  return ({ dispatch, getState }) =&gt; next =&gt; (action) =&gt; {
    if (typeof(action) === 'function') {
      return next(action)
    }

    const {
      channel,
      room,
      leave,
    } = action;
    let { received } = action;

    if (!channel) {
      return next(action);
    }

    if (leave) {
      const subscription = _.find(
        cable.subscriptions.subscriptions,
        sub =&gt; sub.identifier === JSON.stringify({ channel, room }),
      );

      return cable.subscriptions.remove(subscription);
    }

    if (typeof(received) === 'string') {
      received = result =&gt; dispatch({ type: received, result })
    }

    return cable.subscriptions.create({ channel, room }, { received });
  };
}
</pre></table>
</div>
</div>
<p>Lets break down this code:
<p>Basically we first skip our middleware if the action is a function or if there is no <code class="highlighter-rouge">channel</code> attribute in our action.
<p>Then if there is a <code class="highlighter-rouge">leave</code> attribute, then we remove the action cable subscription to the channel+room.
<p>Else we create a subscription to the channel+room.
<p>But you will notice that we are doing some quick logic to check if the <code class="highlighter-rouge">received</code> attribute is a string. And if it is, we are changing its value to a function that dispatches a new action with the received data. So basically our <code class="highlighter-rouge">received</code> attribute can take both an action type string or an actual function. This gives us an extra level of control over how we handle the data coming in from Action Cable.
<p>And any data that is sent from the ActionCable server is included in the <code class="highlighter-rouge">result</code> attribute of the action. So the reducer can have easy access to any data the server sent. Also any extra action attributes (<code class="highlighter-rouge">...rest</code>) are just passed directly through to the dispatched action.
<p>Also notice that the function that we are exporting is returning another function. This is an example of a <a href="https://en.wikipedia.org/wiki/Higher-order_function" title="https://en.wikipedia.org/wiki/Higher-order_function">Higher-order function</a> and is a very useful pattern in Javascript. We will execute the outside function when we apply the middleware to redux which will create the ActionCable connection only once and give the inner function access to that cable connection going forward.
<h3 id="add-middleware-to-redux">Add Middleware to Redux</h3>
<p>Then we have to apply our new middlware. Check the <a href="https://redux.js.org/advanced/middleware#attempt-6-naively-applying-the-middleware" title="https://redux.js.org/advanced/middleware#attempt-6-naively-applying-the-middleware">redux documentation</a> for how to do this. But you will probably need to do something like this when setting up your store:
<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8</pre><td class="code"><pre>import { createStore, applyMiddleware } from 'redux';
import cableMiddleware from './middleware/cableMiddleware';
import rootReducer from './reducers/index';

const store = createStore(
  rootReducer,
  applyMiddleware(cableMiddleware())
);
</pre></table>
</div>
</div>
<p>Since other file is actually exporting a higher-order function, don’t forget to execute the cableMiddleware function when applying it to redux. This will also create the Action Cable connection only once when the store loads so we don’t have to worry about creating a new connection every time.
<h3 id="our-new-action-creators">Our New Action Creators</h3>
<p>We now have access to a new type of action that has new required attributes. Basically if we dispatch an action with a <code class="highlighter-rouge">channel</code> attribute it will trigger our cable middleware.
<p>Here are some example action creators using our new middleware.
<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre><td class="code"><pre>export function subscribeConversation(conversationId) {
  return {
    channel: 'conversations',
    room: `conversation_${conversationId}`,
    received: NEW_MESSAGE,
  }
}

export function unsubscribeConversation(conversationId) {
  return {
    channel: 'conversations',
    room: `conversation_${conversationId}`,
    leave: true,
  }
}

// Action creator with received function:
export function subscribeConversation(conversationId) {
  return dispatch =&gt; dispatch({
    channel: 'conversations',
    room: `conversation_${conversationId}`,
    received: data =&gt; dispatch({
      type: NEW_MESSAGE,
      payload: data.conversation,
    }),
  });
}
</pre></table>
</div>
</div>
<p>You’ll notice these actions don’t even have the required <code class="highlighter-rouge">type</code> attribute, this is because when they are dispatched we hijack the action and do out own thing, so these particular actions never makes it to the reducer.
<p>Instead we have a <code class="highlighter-rouge">channel</code>, <code class="highlighter-rouge">room</code>, and <code class="highlighter-rouge">received</code> attributes required to subscribe to a channel+room, and <code class="highlighter-rouge">channel</code>, <code class="highlighter-rouge">room</code>, and <code class="highlighter-rouge">leave</code>, attributes required to unsubscribe from a channel+room.
<p>The important part here is that <code class="highlighter-rouge">received</code> is either an action string to dispatch when new data comes in, or a function to run when new data comes in.
<h3 id="conclusion">Conclusion</h3>
<p>I’m now a huge fan of redux middleware, I love how it cleans up and simplifies doing complex repetative things in our action creators.
<p>Now we’ve set this up we can subscribe and unsubscribe to rooms and channels very easily, as well as handle the data from the server in very robust and dynamic ways.
</article>
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'nmajor';
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
           <footer>
    <span>A blog filled with adventures in tech</span>
    <span>written by Nicholas Major</span>
</footer>
       </div>
<script type="text/javascript" src="/assets/js/theme.js"></script>
<script type="text/javascript" src="/assets/js/barefoot.js"></script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-48130330-1', 'auto');
      ga('send', 'pageview');
    </script>
    
